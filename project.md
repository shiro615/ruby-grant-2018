# 開発テーマ

- Ruby開発支援ツール（デバッガ、プロファイラ、静的コード解析ツール等）

# プロジェクト名

- gobject-introspection gemのLLVM対応

# プロジェクトの詳細

GObject IntrospectionのRubyバインディングであるgobject-introspection gemの機能拡充を行います。
GObject IntrospectionはCで実装されたライブラリーの言語バインディングを簡単に実装できるようにするライブラリーです。

gobject-introspection gemのメリットは次の3点です。

- RubyっぽいAPIを自動生成できる
  - SWIGはC++ならできる（ことがある）
  - SWIGはCでもユーザーが設定ファイルを頑張って書けばできるが、ライブラリー毎に作らないといけない
  - libffi/Fiddleは自動生成できない
  - 手書きは自動生成できない
- Ruby以外の言語バインディングも自動生成できる
  - SWIGもできる
  - 他の言語の開発者とも協力できる
- 実行時に言語バインディングを自動生成できる
  - SWIGはできない
  - ライブラリーを更新しても言語バインディングを更新する必要はない

ただし、パフォーマンス面で課題があるのでこのプロジェクトではそれを解決し手書きのバインディングと同等の速度でバインド対象の関数を呼び出せることを目指します。

### 現在の課題

以下のようなパフォーマンス面の課題があります

- 動的な引数の変換
  - 手書きのバインディングでは1番目の引数は文字列として変換するというように書けるが、gobject-introspection gemは実行時に1番目の引数の型情報を取得してその情報を元に変換する。そのため、実行時に適切な変換方法を確定するためのコストがかかる。
- libffiを使った関数呼び出し
  - 手書きのバインディングに比べてlibffiを使ったバインディングは約3倍のオーバヘッドがある。

  - 手書きのバインディング(Extension)
  ```
                  user     system      total        real
  Extension   0.550000   0.000000   0.550000 (  0.556729)
  Method      0.570000   0.000000   0.570000 (  0.577752)
  Direct      0.360000   0.010000   0.370000 (  0.368701)
  ```
  https://github.com/kou/rabbit-slide-kou-rubykaigi-2016/tree/master/c-api/performance

  - libffiを使ったバインディング(ffi, Fiddle)
  ```
               user     system      total        real
  ffi      1.480000   0.010000   1.490000 (  1.487364)
  Fiddle   1.470000   0.000000   1.470000 (  1.478364)
  Method   0.540000   0.000000   0.540000 (  0.539982)
  Direct   0.390000   0.000000   0.390000 (  0.397280)
  ```
  https://github.com/kou/rabbit-slide-kou-rubykaigi-2016/tree/master/ffi/performance

### 改善案

- JITコンパイル
- GObject IntrospectionのFFIの機能を使わずに直接バインド対象の関数を呼び出す

実行時に1回だけ適切な変換方法を特定し、その変換方法を使って対象の関数を呼び出す関数をLLVMのC++ APIを使って実行時に作って、以降はその関数を呼び出します。こうすることで以降は実行時に適切な変換方法を決定する必要がありません。すでに実行時に生成した関数内にその情報が入っているからです。

ただし、実行時に関数を生成するのも（実行時間的にもメモリー的にも）コストなのでよく呼ばれる関数だけ対象にすることでバランスを取ります。

# プロジェクトの成果物

- 手書きのバインディングと同等の速度でバインド対象の関数を呼び出せるgobject-introspection gem（本体にマージする）
- 手書きのバインディングとgobject-introspection gemを使ったバインディングのベンチマーク結果
